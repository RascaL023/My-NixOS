;; Eww Configuration - Main Config File (eww.yuck)
;; Put this in ~/.config/eww/eww.yuck

;; Variables
(defpoll time :interval "1s"
  "date '+%H:%M'")

(defpoll date :interval "1m"
  "date '+%A, %d %B'")

(defpoll battery :interval "5s"
  "cat /sys/class/power_supply/BAT0/capacity 2>/dev/null || echo '100'")

(defpoll battery_status :interval "5s"
  "cat /sys/class/power_supply/BAT0/status 2>/dev/null || echo 'Full'")

(deflisten volume :initial "50"
  "scripts/volume.sh --listen")

(deflisten workspaces :initial "[]"
  "scripts/workspaces.sh")

(defpoll cpu :interval "2s"
  "scripts/system.sh --cpu")

(defpoll memory :interval "2s"
  "scripts/system.sh --memory")

(defpoll music_status :interval "1s"
  "scripts/music.sh --status")

(defpoll music_title :interval "1s"
  "scripts/music.sh --title")

(defpoll music_artist :interval "1s"
  "scripts/music.sh --artist")

;; Windows
(defwindow bar
  :monitor 0
  :windowtype "dock"
  :geometry (geometry :x "0%"
                      :y "8px"
                      :width "98%"
                      :height "45px"
                      :anchor "top center")
  :reserve (struts :side "top" :distance "53px")
  (bar))

(defwindow music
  :monitor 0
  :windowtype "normal"
  :geometry (geometry :x "20px"
                      :y "70px"
                      :width "320px"
                      :height "140px"
                      :anchor "top left")
  (music_widget))

(defwindow calendar
  :monitor 0
  :windowtype "normal"
  :geometry (geometry :x "-20px"
                      :y "70px"
                      :width "280px"
                      :height "300px"
                      :anchor "top right")
  (calendar_widget))

(defwindow system
  :monitor 0
  :windowtype "normal"
  :geometry (geometry :x "20px"
                      :y "230px"
                      :width "320px"
                      :height "180px"
                      :anchor "top left")
  (system_widget))

;; Widgets
(defwidget bar []
  (centerbox :class "bar"
    (box :class "bar-segment"
         :halign "start"
         :spacing 15
      (workspaces_widget)
      (music_compact))
    
    (box :class "bar-segment bar-center"
         :halign "center"
      (label :class "clock" :text time)
      (label :class "date" :text date))
    
    (box :class "bar-segment"
         :halign "end"
         :spacing 15
      (systray_widget)
      (volume_widget)
      (battery_widget))))

(defwidget workspaces_widget []
  (box :class "workspaces"
       :spacing 8
    (for workspace in workspaces
      (button :class "workspace ${workspace.active ? 'active' : ''} ${workspace.occupied ? 'occupied' : ''}"
              :onclick "hyprctl dispatch workspace ${workspace.id}"
        (label :text "${workspace.id}")))))

(defwidget music_compact []
  (button :class "music-compact"
          :onclick "eww open music || eww close music"
    (box :spacing 10
      (label :class "music-icon" :text "")
      (label :class "music-text" 
             :limit-width 30
             :text "${music_title != '' ? music_title : 'No Music Playing'}"))))

(defwidget systray_widget []
  (box :class "systray"
       :spacing 8
    (label :text " ")))

(defwidget volume_widget []
  (box :class "volume"
       :spacing 8
    (button :onclick "pamixer -t"
      (label :text "${volume > 50 ? '' : volume > 0 ? '' : ''}"))
    (scale :class "volume-slider"
           :value volume
           :min 0
           :max 100
           :onchange "pamixer --set-volume {}")))

(defwidget battery_widget []
  (box :class "battery ${battery < 20 ? 'critical' : ''}"
       :spacing 8
    (label :text "${battery_status == 'Charging' ? '' : battery > 80 ? '' : battery > 60 ? '' : battery > 40 ? '' : battery > 20 ? '' : ''}")
    (label :text "${battery}%")))

;; Music Widget
(defwidget music_widget []
  (box :class "music-window"
       :orientation "v"
       :spacing 15
    (box :class "music-header"
         :spacing 10
      (label :class "music-icon-big" :text "")
      (box :orientation "v"
           :spacing 5
           :valign "center"
        (label :class "music-title" 
               :limit-width 25
               :halign "start"
               :text "${music_title != '' ? music_title : 'Nothing Playing'}")
        (label :class "music-artist" 
               :limit-width 30
               :halign "start"
               :text "${music_artist != '' ? music_artist : 'Unknown Artist'}")))
    
    (box :class "music-controls"
         :spacing 20
         :halign "center"
      (button :class "music-btn" 
              :onclick "playerctl previous"
        (label :text ""))
      (button :class "music-btn music-play" 
              :onclick "playerctl play-pause"
        (label :text "${music_status == 'Playing' ? '' : ''}"))
      (button :class "music-btn" 
              :onclick "playerctl next"
        (label :text "")))))

;; Calendar Widget
(defwidget calendar_widget []
  (box :class "calendar-window"
       :orientation "v"
    (calendar :class "calendar")))

;; System Monitor Widget
(defwidget system_widget []
  (box :class "system-window"
       :orientation "v"
       :spacing 15
    (box :class "system-item"
         :orientation "v"
         :spacing 8
      (label :class "system-label" :halign "start" :text "CPU Usage")
      (box :spacing 10
        (scale :class "system-bar"
               :value cpu
               :min 0
               :max 100)
        (label :class "system-value" :text "${cpu}%")))
    
    (box :class "system-item"
         :orientation "v"
         :spacing 8
      (label :class "system-label" :halign "start" :text "Memory Usage")
      (box :spacing 10
        (scale :class "system-bar"
               :value memory
               :min 0
               :max 100)
        (label :class "system-value" :text "${memory}%")))))



#!/bin/bash
# Save these scripts in ~/.config/eww/scripts/

# ===== volume.sh =====
# chmod +x ~/.config/eww/scripts/volume.sh
cat > ~/.config/eww/scripts/volume.sh << 'EOF'
#!/bin/bash

get_volume() {
    pamixer --get-volume
}

listen_volume() {
    pactl subscribe | grep --line-buffered "sink" | while read -r _; do
        get_volume
    done
}

case "$1" in
    --listen) listen_volume ;;
    *) get_volume ;;
esac
EOF

# ===== workspaces.sh =====
# chmod +x ~/.config/eww/scripts/workspaces.sh
cat > ~/.config/eww/scripts/workspaces.sh << 'EOF'
#!/bin/bash

# For Hyprland
get_workspaces_hyprland() {
    hyprctl workspaces -j | jq -c 'map({id: .id, occupied: true}) | sort_by(.id)'
}

get_active_workspace() {
    hyprctl activeworkspace -j | jq -r '.id'
}

generate_workspaces() {
    workspaces=$(get_workspaces_hyprland)
    active=$(get_active_workspace)
    
    echo "$workspaces" | jq -c --arg active "$active" '
        map(. + {active: (.id == ($active | tonumber))})
    '
}

# Listen to workspace changes
socat -u UNIX-CONNECT:/tmp/hypr/$HYPRLAND_INSTANCE_SIGNATURE/.socket2.sock - | while read -r line; do
    generate_workspaces
done &

# Initial output
generate_workspaces
wait
EOF

# ===== system.sh =====
# chmod +x ~/.config/eww/scripts/system.sh
cat > ~/.config/eww/scripts/system.sh << 'EOF'
#!/bin/bash

get_cpu() {
    cpu_usage=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}')
    printf "%.0f" "$cpu_usage"
}

get_memory() {
    mem_usage=$(free | grep Mem | awk '{print ($3/$2) * 100.0}')
    printf "%.0f" "$mem_usage"
}

case "$1" in
    --cpu) get_cpu ;;
    --memory) get_memory ;;
    *) echo "Usage: $0 {--cpu|--memory}" ;;
esac
EOF

# ===== music.sh =====
# chmod +x ~/.config/eww/scripts/music.sh
cat > ~/.config/eww/scripts/music.sh << 'EOF'
#!/bin/bash

get_status() {
    status=$(playerctl status 2>/dev/null || echo "Stopped")
    echo "$status"
}

get_title() {
    title=$(playerctl metadata title 2>/dev/null || echo "")
    echo "$title"
}

get_artist() {
    artist=$(playerctl metadata artist 2>/dev/null || echo "")
    echo "$artist"
}

case "$1" in
    --status) get_status ;;
    --title) get_title ;;
    --artist) get_artist ;;
    *) echo "Usage: $0 {--status|--title|--artist}" ;;
esac
EOF

# Make all scripts executable
chmod +x ~/.config/eww/scripts/*.sh

echo "All scripts created and made executable!"
echo "Location: ~/.config/eww/scripts/"

